name: Update Reading & Sync Portfolio

on:
  push:
    paths:
      - "README.md"
      - "**/*.md"
  workflow_dispatch:

jobs:
  sync-content:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repos
        uses: actions/checkout@v4
        with:
          path: personal-library
          
      - name: Checkout Portfolio
        uses: actions/checkout@v4
        with:
          repository: GabrielBaiano/A-new-type-portifolio
          path: portfolio
          token: ${{ secrets.PAT_TOKEN }}

      - name: Parse Everything
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const libraryPath = path.join(process.env.GITHUB_WORKSPACE, 'personal-library');
            const readmePath = path.join(libraryPath, 'README.md');
            const targetJsonPath = path.join(process.env.GITHUB_WORKSPACE, 'portfolio/data/reviews.json');

            const books = new Map(); // Usar Map para evitar duplicados

            // --- 1. PARSE DO README (Livros no Status Atual) ---
            if (fs.existsSync(readmePath)) {
                const content = fs.readFileSync(readmePath, 'utf8');
                const regex = /<td[^>]*>[\s\S]*?<img src="([^"]+)"[^>]*width="120"[\s\S]*?<a[^>]*><b>([^<]+)<\/b><\/a>[\s\S]*?Status: <b>([^<]+)<\/b>/g;
                
                let match;
                while ((match = regex.exec(content)) !== null) {
                    const title = match[2].trim();
                    const status = match[3].includes('Reading') ? 'Reading' : 'Finished';
                    const folderName = title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');

                    books.set(folderName, {
                        image: match[1],
                        title: title,
                        status: status,
                        id: folderName.replace(/_/g, '-'),
                        link: 'https://github.com/GabrielBaiano/personal-library',
                        date: new Date().toISOString().split('T')[0]
                    });
                }
            }

            // --- 2. VARREDURA DE PASTAS (Especial Recomendations & Reviews) ---
            const scanFolders = ['2026', '2025', 'special_recomendações'];
            scanFolders.forEach(dirName => {
                const dirPath = path.join(libraryPath, dirName);
                if (!fs.existsSync(dirPath)) return;

                const items = fs.readdirSync(dirPath);
                items.forEach(item => {
                    const itemPath = path.join(dirPath, item);
                    if (fs.statSync(itemPath).isDirectory()) {
                        const files = fs.readdirSync(itemPath);
                        const mdFile = files.find(f => f.endsWith('.md'));
                        
                        if (mdFile) {
                            const content = fs.readFileSync(path.join(itemPath, mdFile), 'utf8');
                            const bookKey = item.toLowerCase();
                            
                            // Tenta pegar título e imagem do MD se não tiver no README
                            let existing = books.get(bookKey) || {
                                id: item.replace(/_/g, '-'),
                                title: item.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                                status: 'Finished',
                                image: 'https://via.placeholder.com/300x450?text=' + item,
                                date: new Date().toISOString().split('T')[0]
                            };

                            existing.content = content;
                            if (dirName.includes('special')) existing.status = 'Finished'; // Força status pra especiais
                            
                            books.set(bookKey, existing);
                        }
                    }
                });
            });

            // --- 3. SALVAR ---
            let currentData = { shelves: [], reviews: [] };
            currentData.reviews = Array.from(books.values());
            fs.writeFileSync(targetJsonPath, JSON.stringify(currentData, null, 2));

      - name: Commit
        run: |
          cd portfolio
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/reviews.json
          if [[ -n $(git status -s) ]]; then
            git commit -m "feat(content): Sync everything (README + Folders)"
            git push
          fi