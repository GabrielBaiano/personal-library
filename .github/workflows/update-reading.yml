name: Update Reading & Sync Portfolio

on:
  push:
    paths:
      - "README.md"
  workflow_dispatch:

jobs:
  sync-content:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Personal Library
        uses: actions/checkout@v4
        with:
          path: personal-library

      - name: Checkout Profile Repo
        uses: actions/checkout@v4
        with:
          repository: GabrielBaiano/GabrielBaiano
          path: GabrielBaiano
          token: ${{ secrets.PAT_TOKEN }}

      - name: Checkout Portfolio Repo
        uses: actions/checkout@v4
        with:
          repository: GabrielBaiano/A-new-type-portifolio
          path: portfolio
          token: ${{ secrets.PAT_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Run Profile Update Script
        run: |
          cd personal-library
          if [ -f "scripts/update-reading.js" ]; then
            node scripts/update-reading.js
          else
            echo "Warning: scripts/update-reading.js not found, skipping profile update."
          fi

      - name: Parse and Update Reviews JSON
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const readmePath = path.join(process.env.GITHUB_WORKSPACE, 'personal-library/README.md');
            const targetJsonPath = path.join(process.env.GITHUB_WORKSPACE, 'portfolio/data/reviews.json');

            if (!fs.existsSync(readmePath)) {
                console.log('README not found');
                return;
            }
            const content = fs.readFileSync(readmePath, 'utf8');

            // Regex Updated for your specific HTML Format
            const regex = /<td[^>]*>[\s\S]*?<img src="([^"]+)"[^>]*width="120"[\s\S]*?<a[^>]*><b>([^<]+)<\/b><\/a>[\s\S]*?Status: <b>([^<]+)<\/b>/g;
            
            const books = [];
            let match;
            while ((match = regex.exec(content)) !== null) {
                const rawStatus = match[3];
                const cleanStatus = rawStatus.includes('Reading') ? 'Reading' : 'Finished';

                books.push({
                    image: match[1],
                    title: match[2],
                    status: cleanStatus,
                    tag: 'Book',
                    id: match[2].toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-'),
                    link: 'https://github.com/GabrielBaiano/personal-library',
                    date: new Date().toISOString().split('T')[0]
                });
            }

            console.log(`Parsed ${books.length} books.`);

            let currentData = { shelves: [], reviews: [] };
             if (fs.existsSync(targetJsonPath)) {
                try {
                    currentData = JSON.parse(fs.readFileSync(targetJsonPath, 'utf8'));
                } catch (e) { console.log('Error reading existing JSON, starting fresh'); }
            }
            currentData.reviews = books;

            fs.writeFileSync(targetJsonPath, JSON.stringify(currentData, null, 2));

      - name: Commit Portfolio Updates
        run: |
          cd portfolio
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/reviews.json
          if [[ -n $(git status -s) ]]; then
            git commit -m "feat(content): Sync books from personal-library"
            git push
          else
            echo "No changes to commit in Portfolio"
          fi

      - name: Commit Profile Updates
        run: |
          cd GabrielBaiano
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          if [[ -n $(git status -s) ]]; then
            git add README.md
            git commit -m "chore: update reading books"
            git push
          else
            echo "No changes to commit in Profile"
          fi

      - name: Commit Library Updates
        run: |
          cd personal-library
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          if [[ -n $(git status -s) ]]; then
            git add README.md
            git commit -m "chore: sync reading markers"
            git push
          else
            echo "No changes to commit in Library"
          fi