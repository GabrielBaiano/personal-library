name: Update Reading & Sync Portfolio

on:
  push:
    paths:
      - "README.md"
      - "**/*.md"
  workflow_dispatch:

jobs:
  sync-content:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repos
        uses: actions/checkout@v4
        with:
          path: personal-library
          
      - name: Checkout Portfolio
        uses: actions/checkout@v4
        with:
          repository: GabrielBaiano/A-new-type-portifolio
          path: portfolio
          token: ${{ secrets.PAT_TOKEN }}

      - name: Parse Everything (Fixed Accents & Folder Scan)
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            const libraryPath = path.join(process.env.GITHUB_WORKSPACE, 'personal-library');
            const readmePath = path.join(libraryPath, 'README.md');
            const targetJsonPath = path.join(process.env.GITHUB_WORKSPACE, 'portfolio/data/reviews.json');

            const books = new Map();

            // 1. Pega os livros do README (Current Reading)
            if (fs.existsSync(readmePath)) {
                const content = fs.readFileSync(readmePath, 'utf8');
                const regex = /<td[^>]*>[\s\S]*?<img src="([^"]+)"[^>]*width="120"[\s\S]*?<a[^>]*><b>([^<]+)<\/b><\/a>[\s\S]*?Status: <b>([^<]+)<\/b>/g;
                let match;
                while ((match = regex.exec(content)) !== null) {
                    const title = match[2].trim();
                    const status = match[3].includes('Reading') ? 'Reading' : 'Finished';
                    const id = title.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');

                    books.set(id, {
                        image: match[1],
                        title: title,
                        status: status,
                        id: id,
                        link: 'https://github.com/GabrielBaiano/personal-library',
                        date: new Date().toISOString().split('T')[0]
                    });
                }
            }

            // 2. Procura por arquivos Markdown em todas as pastas (Duna, etc)
            const allItems = fs.readdirSync(libraryPath);
            const categories = allItems.filter(f => /^\d{4}$/.test(f) || f.toLowerCase().includes('special'));

            categories.forEach(cat => {
                const catPath = path.join(libraryPath, cat);
                if (!fs.statSync(catPath).isDirectory()) return;

                const bookFolders = fs.readdirSync(catPath);
                bookFolders.forEach(folder => {
                    const bookPath = path.join(catPath, folder);
                    if (fs.statSync(bookPath).isDirectory()) {
                        const files = fs.readdirSync(bookPath);
                        const mdFile = files.find(f => f.endsWith('.md'));
                        
                        if (mdFile) {
                            const mdContent = fs.readFileSync(path.join(bookPath, mdFile), 'utf8');
                            const id = folder.toLowerCase().replace(/_/g, '-');
                            
                            let bookData = books.get(id) || {
                                id: id,
                                title: folder.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                                status: 'Finished',
                                image: 'https://via.placeholder.com/300x450?text=' + folder,
                                link: 'https://github.com/GabrielBaiano/personal-library',
                                date: new Date().toISOString().split('T')[0]
                            };

                            bookData.content = mdContent;
                            if (cat.toLowerCase().includes('special')) bookData.status = 'Finished';
                            
                            books.set(id, bookData);
                            console.log('âœ… Livro encontrado na pasta:', folder);
                        }
                    }
                });
            });

            const finalData = { shelves: [], reviews: Array.from(books.values()) };
            fs.writeFileSync(targetJsonPath, JSON.stringify(finalData, null, 2));

      - name: Commit
        run: |
          cd portfolio
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/reviews.json
          if [[ -n $(git status -s) ]]; then
            git commit -m "feat(content): sync dynamic reviews and special recommendations"
            git push
          fi